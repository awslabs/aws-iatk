name: release

on:
  pull_request:

jobs:
  check_version_bump:
    name: check version on macos-latest
    runs-on: macos-latest

    steps:
      - name: checkout develop branch
        uses: actions/checkout@v4
        with:
            ref: develop
      - id: version-develop
        name: print version
        working-directory: ./python-client
        run: echo "VERSION_DEVELOP=$(awk '/version =/ {print $3}' pyproject.toml)" >> "$GITHUB_ENV"

      - name: checkout source branch
        uses: actions/checkout@v4

      - id: version-source
        name: print version
        working-directory: ./python-client
        run: echo "VERSION_SOURCE=$(awk '/version =/ {print $3}' pyproject.toml)" >> "$GITHUB_ENV"
          

      - name: Check if versions are the same
        run: 
            if [ $VERSION_SOURCE = $VERSION_DEVELOP ]; then 
                  echo "No version change, exiting!";
                  exit 1;
                else
                  echo Versions are different;
                  exit 0;
                fi
    
  release:
    name: release on macos-latest
    runs-on: macos-latest
    needs: check_version_bump
    steps:
      - uses: actions/setup-python@v3

      - name: Install dependencies
        run: |
            python -m pip install --upgrade pip
                pip install setuptools wheel twine awscli
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
            aws-access-key-id: ${{ secrets.AWS_CA_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_CA_SECRET_ACCESS_KEY }}
            aws-region: eu-central-1
                    
                    aws codeartifact login --tool twine --repository zion-wheels --domain aws --domain-owner 010155974629 --region us-east-1
                    twine upload dist/*
      
